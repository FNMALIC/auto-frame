"""Virtual webcam module using pyvirtualcam"""
import cv2
import numpy as np
import pyvirtualcam
import subprocess
from typing import Optional


class VirtualCamera:
    """Creates and manages virtual webcam device"""

    def __init__(
        self,
        width: int,
        height: int,
        fps: int,
        device_name: str = "Smart Meeting Camera"
    ):
        """
        Initialize virtual camera

        Args:
            width: Frame width
            height: Frame height
            fps: Frames per second
            device_name: Name of virtual camera device
        """
        self.width = width
        self.height = height
        self.fps = fps
        self.device_name = device_name
        self.cam: Optional[pyvirtualcam.Camera] = None

        self._initialize()

    def _find_v4l2loopback_devices(self):
        """Find v4l2loopback output devices using v4l2-ctl"""
        loopback_devices = []

        try:
            # Run v4l2-ctl to list devices
            result = subprocess.run(
                ['v4l2-ctl', '--list-devices'],
                capture_output=True,
                text=True,
                timeout=5
            )

            if result.returncode == 0:
                lines = result.stdout.split('\n')
                is_loopback = False

                for line in lines:
                    # Check if this is a loopback device section
                    if 'v4l2loopback' in line.lower() or 'smart' in line.lower():
                        is_loopback = True
                        continue

                    # If we're in a loopback section, collect the device path
                    if is_loopback and line.strip().startswith('/dev/video'):
                        device_path = line.strip()
                        loopback_devices.append(device_path)
                        is_loopback = False  # Reset for next device
                    elif line.strip() and not line.startswith('\t') and not line.startswith(' '):
                        # New device section started
                        is_loopback = False

        except (subprocess.TimeoutExpired, FileNotFoundError, Exception) as e:
            print(f"Could not run v4l2-ctl: {e}")

        return loopback_devices

    def _initialize(self) -> None:
        """Initialize the virtual camera"""
        import os

        # Find v4l2loopback devices
        loopback_devices = self._find_v4l2loopback_devices()

        # Prioritize /dev/video10, then other loopback devices
        devices_to_try = []
        if '/dev/video10' in loopback_devices:
            devices_to_try.append('/dev/video10')

        # Add other loopback devices
        devices_to_try.extend([d for d in loopback_devices if d != '/dev/video10'])

        # Fallback: try common loopback device numbers if none found
        if not devices_to_try:
            for num in [10, 20, 2, 3, 4, 5]:
                device = f'/dev/video{num}'
                if os.path.exists(device):
                    devices_to_try.append(device)

        print(f"Attempting to use virtual camera devices: {devices_to_try}")

        # Try each device
        last_error = None
        for device_path in devices_to_try:
            try:
                self.cam = pyvirtualcam.Camera(
                    width=self.width,
                    height=self.height,
                    fps=self.fps,
                    fmt=pyvirtualcam.PixelFormat.RGB,
                    device=device_path
                )
                print(f"✓ Virtual camera created successfully: {self.cam.device}")
                return
            except Exception as e:
                last_error = e
                print(f"✗ Failed to create virtual camera on {device_path}: {e}")
                continue

        # If all attempts failed, try without specifying device (let pyvirtualcam auto-detect)
        try:
            print("Attempting auto-detection...")
            self.cam = pyvirtualcam.Camera(
                width=self.width,
                height=self.height,
                fps=self.fps,
                fmt=pyvirtualcam.PixelFormat.RGB
            )
            print(f"✓ Virtual camera created (auto-detected): {self.cam.device}")
        except Exception as e:
            error_msg = f"Failed to create virtual camera: {e}"
            if last_error:
                error_msg += f"\nLast device error: {last_error}"
            error_msg += "\n\nTroubleshooting:"
            error_msg += "\n1. Ensure v4l2loopback is loaded: sudo modprobe v4l2loopback"
            error_msg += "\n2. Check devices: v4l2-ctl --list-devices"
            error_msg += "\n3. Verify permissions: ls -la /dev/video*"
            raise RuntimeError(error_msg)

    def send_frame(self, frame: np.ndarray) -> None:
        """
        Send frame to virtual camera

        Args:
            frame: Frame in BGR format (OpenCV default)
        """
        if not self.is_active():
            return

        # Validate frame
        if frame is None or frame.size == 0:
            return

        # Ensure frame is correct size
        if frame.shape[:2] != (self.height, self.width):
            frame = cv2.resize(frame, (self.width, self.height))

        # Convert BGR to RGB
        rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

        # Send to virtual camera
        try:
            self.cam.send(rgb_frame)
        except Exception as e:
            print(f"Error sending frame to virtual camera: {e}")

    def is_active(self) -> bool:
        """Check if virtual camera is active"""
        return self.cam is not None

    def close(self) -> None:
        """Close virtual camera"""
        if self.cam is not None:
            self.cam.close()
            self.cam = None

    def __enter__(self):
        """Context manager entry"""
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """Context manager exit"""
        self.close()
        return False

    def __del__(self):
        """Destructor to ensure cleanup"""
        self.close()